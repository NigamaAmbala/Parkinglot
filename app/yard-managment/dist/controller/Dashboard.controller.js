sap.ui.define(["./BaseController","sap/ui/Device","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox","sap/m/MessageToast"],function(e,t,s,i,o,r,n,a){"use strict";return e.extend("com.app.yardmanagment.controller.Dashboard",{onInit:function(){var e=new s(sap.ui.require.toUrl("com/app/yardmanagment/model/data.json"));this.getView().setModel(e);var t=this.getOwnerComponent().getModel("ModelV2");this.getView().byId("pageContainer").setModel(t);this._setParkingLotModel();const i=new s({VDetails:{vehicleNo:"",driverName:"",phoneNumber:"",vehicleType:"",inTime:"",UnassignedDate:"",parkinglot_lotId:""},parkinglot:{parkingType:false}});this.getView().setModel(i,"localModel")},onItemSelect:function(e){var t=e.getParameter("item");this.byId("pageContainer").to(this.getView().createId(t.getKey()))},onSideNavButtonPress:function(){var e=this.byId("toolPage");var t=e.getSideExpanded();this._setToggleButtonTooltip(t);e.setSideExpanded(!e.getSideExpanded())},_setToggleButtonTooltip:function(e){var t=this.byId("sideNavigationToggleButton");if(e){t.setTooltip("Large Size Navigation")}else{t.setTooltip("Small Size Navigation")}},statusTextFormatter:function(e){return e?"Empty":"Not Empty"},onValueHelpRequest:function(e){var t=e.getSource().getValue(),s=this.getView();if(!this._pValueHelpDialog){this._pValueHelpDialog=i.load({id:s.getId(),name:"com.app.yardmanagment.Fragments.Valuehelp",controller:this}).then(function(e){s.addDependent(e);return e})}this._pValueHelpDialog.then(function(e){e.setModel(this.getView().getModel("ModelV2"));e.getBinding("items").filter([new o("lotId",r.Contains,t)]);e.open(t)}.bind(this))},onValueHelpDialogSearch:function(e){var t=e.getParameter("value");var s=new o("lotId",r.Contains,t);e.getSource().getBinding("items").filter([s])},onValueHelpDialogClose:function(e){var t,s=e.getParameter("selectedItem");e.getSource().getBinding("items").filter([]);if(!s){return}t=s.getDescription();this.byId("productInput").setSelectedKey(t)},onValueHelpRequest1:function(e){var t=e.getSource().getValue(),s=this.getView();if(!this._pValueHelpDialog){this._pValueHelpDialog=i.load({id:s.getId(),name:"com.app.yardmanagment.Fragments.ValueHelp",controller:this}).then(function(e){s.addDependent(e);return e})}this._pValueHelpDialog.then(function(e){e.setModel(this.getView().getModel("ModelV2"));e.getBinding("items").filter([new o("lotId",r.Contains,t)]);e.open(t)}.bind(this))},onValueHelpDialogSearch1:function(e){var t=e.getParameter("value");var s=new o("lotId",r.Contains,t);e.getSource().getBinding("items").filter([s])},onValueHelpDialogClose1:function(e){var t,s=e.getParameter("selectedItem");e.getSource().getBinding("items").filter([]);if(!s){return}t=s.getDescription();this.byId("productInput1").setSelectedKey(t)},onAssignPressbtn:async function(){const e=this.getView().byId("page2").getModel("localModel").getProperty("/");const{driverName:t,phoneNumber:s,vehicleNo:i,vehicleType:o}=e.VDetails;const r=this.getView().byId("pageContainer").getModel("ModelV2");const n=this.getView().byId("productInput").getValue();e.VDetails.parkinglot_lotId=n;const l=new Date;e.VDetails.inTime=l;if(!(t&&s&&i&&o)){sap.m.MessageToast.show("Enter all details");return}var c=s.trim();var g=/^(?:(?:\+|0{0,2})91(\s*[\-]\s*)?|[0]?)?[789]\d{9}$/;if(!g.test(c)){sap.m.MessageToast.show("Please enter a valid phone number");return}var d=await this.checkVehicleNo(r,e.VDetails.vehicleNo);if(d){a.show("Vehicle already exsist");return}const u=await this.checkPlotAvailability(r,n);if(!u){sap.m.MessageToast.show("Plot not available for assignment.");return}var p=await this.checkParkingLotReservation(r,n);if(p){sap.m.MessageBox.error(`Parking lot ${n} is already reserved. Please select another parking lot.`,{title:"Reservation Information",actions:sap.m.MessageBox.Action.OK});return}try{await this.createData(r,e.VDetails,"/VDetails");sap.m.MessageToast.show(`${i} allocated to Slot No ${n}`);r.update("/Parkinglot('"+n+"')",e.parkinglot,{success:function(){},error:function(e){sap.m.MessageBox.error("Failed to update: "+e.message)}});this.onclearPress()}catch(e){console.error("Error:",e)}},checkVehicleNo:async function(e,t){return new Promise((s,i)=>{e.read("/VDetails",{filters:[new o("vehicleNo",r.EQ,t)],success:function(e){s(e.results.length>0)},error:function(){i("An error occurred while checking vehicle existence.")}})})},checkPlotAvailability:async function(e,t){return new Promise((s,i)=>{e.read("/Parkinglot('"+t+"')",{success:function(e){s(e.parkingType)},error:function(e){i("Error checking plot availability: "+e.message)}})})},checkPlotEmpty:async function(e,t){return new Promise((s,i)=>{e.read("/VDetails",{filters:[new o("vehicleNo",r.EQ,t)],success:function(e){s(e.results.length>0)},error:function(){i("An error occurred while checking username existence.")}})})},checkParkingLotReservation:async function(e,t){return new Promise((s,i)=>{e.read("/Reservations",{filters:[new sap.ui.model.Filter("parkinglot_lotId",sap.ui.model.FilterOperator.EQ,t)],success:function(e){s(e.results.length>0)},error:function(){i("An error occurred while checking parking lot reservation.")}})})},onclearPress:function(){var e=this.getView().getModel("localModel");e.setProperty("/VDetails",{vehicleNo:"",driverName:"",phoneNumber:"",vehicleType:"",parkinglot_lotId:""});this.getView().byId("productInput").setValue("")},onUnassignPressbtn:async function(){try{const e=this.getView().byId("page2").getModel("localModel").getProperty("/");const{driverName:t,phoneNumber:s,vehicleNo:i,vehicleType:o}=e.VDetails;const r=this.getView().byId("pageContainer").getModel("ModelV2");const n=this.getView().byId("productInput").getValue();e.VDetails.parkinglot_lotId=n;const a=new Date;e.VDetails.UnassignedDate=a;await this.createData(r,e.VDetails,"/History");await this.deleteData(r,"/VDetails",i);const l={parkingType:true};r.update("/Parkinglot('"+n+"')",l,{success:function(){sap.m.MessageBox.success(`Vehicle ${i} unassigned successfully. Parking lot ${n} is empty.`)},error:function(e){sap.m.MessageBox.error("Failed to update parking lot: "+e.message)}});this.onclearPress()}catch(e){console.error("Error:",e);sap.m.MessageBox.error("Failed to unassign vehicle: "+e.message)}},vehiclenumber:function(e){debugger;const t=this.getView().byId("page2").getModel("localModel");const s=this.getView().byId("pageContainer").getModel("ModelV2");const i=e.getParameter("value");s.read("/VDetails",{filters:[new o("vehicleNo",r.EQ,i)],success:function(e){var s=e.results;if(s.length>0){var i=s[0];t.setProperty("/VDetails/vehicleNo",i.vehicleNo);t.setProperty("/VDetails/driverName",i.driverName);t.setProperty("/VDetails/phoneNumber",i.phoneNumber);t.setProperty("/VDetails/vehicleType",i.vehicleType);t.setProperty("/VDetails/inTime",i.inTime);t.setProperty("/VDetails/parkinglot_lotId",i.parkinglot_lotId);this.oView.byId("productInput").setValue(i.parkinglot_lotId)}else{sap.m.MessageToast.show("Vehicle number not found.");t.setProperty("/VDetails/vehicleNo","");t.setProperty("/VDetails/driverName","");t.setProperty("/VDetails/phoneNumber","");t.setProperty("/VDetails/vehicleType","");t.setProperty("/VDetails/inTime","")}}.bind(this),error:function(e){}})},onReservePressbtn:async function(){const e=this.getView().byId("InputVehicleno").getValue();const t=this.getView().byId("InputDriverName").getValue();const i=this.getView().byId("InputPhonenumber").getValue();const o=this.getView().byId("InputVehicletype").getValue();const r=this.getView().byId("InputEstimatedtime").getValue();const n=new s({Reservations:{vehicleNo:e,driverName:t,phoneNumber:i,vehicleType:o,ReservedDate:r,parkinglot_lotId:""},parkinglot:{parkingType:false}});this.getView().setModel(n,"reserveModel");const a=this.getView().byId("page7").getModel("reserveModel").getProperty("/");const l=this.getView().byId("pageContainer").getModel("ModelV2");const c=this.getView().byId("productInput1").getValue();a.Reservations.parkinglot_lotId=c;var g=i.trim();var d=/^(?:(?:\+|0{0,2})91(\s*[\-]\s*)?|[0]?)?[789]\d{9}$/;if(!d.test(g)){sap.m.MessageToast.show("Please enter a valid phone number");return}if(!e||!e.match(/^[\w\d]{1,10}$/)){sap.m.MessageBox.error("Please enter a valid vehicle number (alphanumeric, up to 10 characters).");return}const u=await this.checkVehicleExists(l,e);if(u){sap.m.MessageBox.error("Vehicle number already Assigned. Please enter a different vehicle number.");return}try{await this.createData(l,a.Reservations,"/Reservations");sap.m.MessageToast.show(`${e} Reserved to Slot No ${c}`);this.onclearPress1()}catch(e){console.error("Error:",e)}},checkVehicleExists:async function(e,t){return new Promise((s,i)=>{e.read("/VDetails",{filters:[new o("vehicleNo",r.EQ,t)],success:function(e){s(e.results.length>0)},error:function(){i("An error occurred while checking vehicle number existence.")}})})},onclearPress1:function(){var e=this.getView().getModel("reserveModel");e.setProperty("/Reservations",{vehicleNo:"",driverName:"",phoneNumber:"",vehicleType:"",ReservedDate:"",parkinglot_lotId:""});this.getView().byId("productInput1").setValue("")},onpressassignrd:async function(){debugger;var e=this.byId("idReserved").getSelectedItems();if(e.length===0){n.error("Please Select atleast row to Assign");return}var t=this.byId("idReserved").getSelectedItem().getBindingContext().getObject();var i=this.byId("idReserved").getSelectedItem().getBindingContext().getPath();const o=new Date;var r=new s({vehicleNo:t.vehicleNo,driverName:t.driverName,phoneNumber:t.phoneNumber,vehicleType:t.vehicleType,inTime:o,parkinglot_lotId:t.parkinglot_lotId});var a=t.parkinglot_lotId;const l=this.getView().byId("pageContainer").getModel("ModelV2");debugger;this.getView().byId("page8").setModel(r,"resmodel");this.getView().byId("page8").getModel("resmodel").getProperty("/");l.create("/VDetails",r.getData(),{success:function(e){debugger;l.remove(i,{success:function(){l.refresh();l.update("/Parkinglot('"+a+"')",{parkingType:false},{success:function(){sap.m.MessageBox.success(`Reserved Vehicle ${t.vehicleNo} assigned successfully to plot ${t.parkinglot_lotId}.`);l.refresh()},error:function(){sap.m.MessageBox.error("Unable to Update")}})},error:function(e){sap.m.MessageBox.error("Failed to update : "+e.message)}})},error:function(e){sap.m.MessageBox.error("Failed to update : "+e.message)}})},onGoPress:function(){const e=this.getView(),t=e.byId("searchinput"),s=t.getValue(),i=e.byId("idReserved"),n=[];s?n.push(new o("vehicleNo",r.EQ,s)):"";i.getBinding("items").filter(n);this.onclearFilterPress()},onclearFilterPress:function(){const e=this.getView(),t=e.byId("searchinput").setValue()},_setParkingLotModel:function(){var e=this.getOwnerComponent().getModel("ModelV2");var t=this;e.read("/Parkinglot",{success:function(e){console.log("Fetched Data:",e);var i=e.results;var o=i.filter(e=>e.parkingType===true).length;var r=i.filter(e=>e.parkingType===false).length;var n={Items:[{parkingType:true,Count:o,parkingType:"Available"},{parkingType:false,Count:r,parkingType:"Occupied"}]};var a=new s;a.setData(n);t.getView().setModel(a,"ParkingLotModel")},error:function(e){console.error(e)}})},onEdit:function(){var e=this.byId("idAllocatedSlots");var t=e.getSelectedItems();if(t.length===0){sap.m.MessageToast.show("Please select an item to edit.");return}t.forEach(function(e){var t=e.getCells();t.forEach(function(e){var t=e.getItems();t[0].setVisible(false);t[1].setVisible(true)})});this.byId("editButton").setVisible(false);this.byId("saveButton").setVisible(true);this.byId("cancelButton").setVisible(true)},onCancel:function(){var e=this.byId("idAllocatedSlots");var t=e.getSelectedItems();t.forEach(function(e){var t=e.getCells();t.forEach(function(e){var t=e.getItems();t[0].setVisible(true);t[1].setVisible(false)})});this.byId("editButton").setVisible(true);this.byId("saveButton").setVisible(false);this.byId("cancelButton").setVisible(false)},onSave:function(){const e=this.getView();const t=this.byId("idAllocatedSlots");const s=t.getSelectedItems();const i=t.getSelectedItem();if(i){const e=i.getBindingContext().getObject();const s=e.vehicleNo;const r=e.vehicleType;const n=e.phoneNumber;const a=e.driverName;var o=e.parkinglot_lotId;const l=i.getCells()[0].getItems()[1];const c=l.getSelectedKey();const g={vehicleNo:s,inTime:new Date,vehicleType:r,driverName:a,phoneNumber:n,parkinglot:{lotId:c}};const d=this.getOwnerComponent().getModel("ModelV2");d.update("/VDetails('"+s+"')",g,{success:function(){const e={parkingType:true};d.update("/Parkinglot('"+o+"')",e,{success:function(){const e={parkingType:false};d.update("/Parkinglot('"+c+"')",e,{success:function(){t.getBinding("items").refresh();sap.m.MessageBox.success("Slot updated successfully")},error:function(e){sap.m.MessageBox.error("Failed to update new slot: "+e.message)}})},error:function(e){sap.m.MessageBox.error("Failed to update old slot: "+e.message)}})},error:function(e){sap.m.MessageBox.error("Failed to update VDetails: "+e.message)}})}s.forEach(function(e){var t=e.getCells();t.forEach(function(e){var t=e.getItems();t[0].setVisible(true);t[1].setVisible(false)})});this.byId("editButton").setVisible(true);this.byId("saveButton").setVisible(false);this.byId("cancelButton").setVisible(false)}})});
//# sourceMappingURL=Dashboard.controller.js.map